{% extends 'master.html' %}
{% block title %} 博物館頁面 {% endblock %}
{% block css %}
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static "css/all.min.css" %}">

    <link rel="stylesheet" href="{% static "css/museum.css" %}">
{% endblock %}


{#</head>#}
{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-6 imgWrapper museumWrapper">
                <img src="{% static "img/palace.jpg" %}" alt="">
            </div>
            <div class="col-6 museum">
                <div class="infoWrapper">
                    <div class="museumName">國立故宮博物院</div>
                    <div class="museumAddress">台北市士林區至善路二段221號</div>
                </div>
            </div>
        </div>
        <div class="col-12 introWrapper">
            <div class="row museumIntro">
                <div class="title">館方簡介：</div>
                <div class="content">國立故宮博物院典藏為數近70萬件冊的藝術品和文物，藏品時間跨 度涵蓋新石器時代至今長達8,000年。當中以長篇銘文的青銅器、
                    古代早期的名家書畫、善本古籍和官窯瓷器等蒐藏最具影響力。
                </div>
            </div>
        </div>
        <hr>
        <div class='input_area'>
            <form action="/museum" method="post">
                {% csrf_token %}
                <label for="CommentTitle">我想說點什麼</label><br>
                <input id="comment_content" type="text" name="comment_content" value="" style='width:90%;'>
                <button id='send' type='button'>送出</button>
            </form>
        </div>
        <div class="row commentTitle">經驗分享</div>
        <div id="commentBlock" class="commentBlock">
        <!--   {% for comment in all_comment.reverse %}
                <div class="row comment">
                    <div class="imgWrapper headWrapper col-1">
                        <img src="static/img/owl.png" alt="">
                    </div>
                    <div id='test' class="col-10">
                        <div class="userName">{{comment.user}}</div>
                        <div class="commentContent">{{comment.comment}}</div>
                    </div>            
                </div>
            {% endfor %}--> 
        </div>
    </div>
<script src="http://apps.bdimg.com/libs/jquery/1.11.1/jquery.min.js"></script>
<script>
    $(document).ready(function(){
        var orgcomment_leng = '{{all_comment|length}}'  //頁面初始comment筆數
        $.ajax({
            type: 'POST',
            url: '/ajax_get_comment',
            dataType:'json',
            data: {
                csrfmiddlewaretoken: $("[name='csrfmiddlewaretoken']").val(),
            },
            success: function(data){
                for(var cid in data){
                    $('#commentBlock').prepend('<div id="two_layer" class="row comment"><div class="imgWrapper headWrapper col-1"><img src="static/img/owl.png" alt=""></div><div id="test" class="col-10"><div class="userName">'+data[cid].user+'</div><div class="commentContent">'+data[cid].comment+'</div></div><button id="remove" class="remove" type="button" value="'+cid+'">刪除</button></div>')
                }
                
            },
        })
        $("#commentBlock").on("click",".remove", function(){
            var this_this = $(this)
            $.ajax({
                type: 'POST',
                url: '/ajax_delete_comment',
                data: {
                    csrfmiddlewaretoken: $("[name='csrfmiddlewaretoken']").val(),
                    delete_cid: $(this).attr('value'),
                },
                success: function(data){
                    data=='success' ? this_this.parent('div').remove() : console.log('comment remove fail')
                },
            })
        })
        $("#send").click(function(){
            var comment_content = $("#comment_content").val()
            $("#comment_content").val("")
            var shell = $('#commentBlock')
            $.ajax({
                type: 'POST',
                url: '/museum',
                dataType: 'json',
                data: {
                    csrfmiddlewaretoken: $("[name='csrfmiddlewaretoken']").val(),
                    'comment_content': comment_content
                },
                success: function(data){
                    /* 方法一
                    var now_len = 0
                    for(var count in data) {
                        now_len++
                    }
                    var counter = 0 //暫存data的count數
                    for(let key in data){
                        if (counter++ > orgcomment_leng-1){
                            $('#commentBlock').prepend('<div class="row comment"><div class="imgWrapper headWrapper col-1"><img src="static/img/owl.png" alt=""></div><div id="test" class="col-10"><div class="userName">'+data[key].user+'</div><div class="commentContent">'+data[key].comment+'</div></div><button id="remove" class="remove" type="button" value="'+key+'">刪除</button></div>')
                        }
                        //$('#col-10').prepend("<p>???</p>")
                    }
                    orgcomment_leng = now_len
                    */

                    // 方法二
                    $('div.commentBlock').children().remove()
                    for(let key in data) {
                        $('#commentBlock').prepend('<div id="two_layer" class="row comment"><div class="imgWrapper headWrapper col-1"><img src="static/img/owl.png" alt=""></div><div id="test" class="col-10"><div class="userName">'+data[key].user+'</div><div class="commentContent">'+data[key].comment+'</div></div><button id="remove" class="remove" type="button" value="'+key+'">刪除</button></div>')
                    }
                }
            })
      });
    });
</script>
{% endblock %}
